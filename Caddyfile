(redirs) {
  # Legacy pages (start redirect Feb 2023)
  redir /art /about 301 # stop redir after Aug 2023

  # Legacy pages (redir for eternity)
  redir /assets/line_invite.jpg https://line.me/R/ti/p/doamatto 301
  redir /legal/environmental /legal/ 301
  redir /privacy /legal/ 301
  redir /imprint /legal/ 301
  redir /use /uses 301
  redir /stack /uses 301
  redir /blog/apple-mar2022 /blog/apple-march-22
  redir /blog/apple-oct2021 /blog/apple-october-21
}

# 404 redirects
(handle_404) {
  handle_errors {
    rewrite * /404.html
    encode zstd gzip
    file_server {
      precompressed br
    }
  }
}

# Base headers
(base_heads) {
  # Cache control
  header Cache-Control "max-age=3600"
  header /static/* Cache-Control "max-age=31536000"

  # Security
  header Content-Security-Policy "default-src 'none'; style-src 'self'; img-src 'self' data: https://fm.doamatto.xyz; form-action 'none'; base-uri 'self'; frame-ancestors 'none'; upgrade-insecure-requests; block-all-mixed-content"
  header Permissions-Policy "interest-cohort=(), browsing-topics=(), join-ad-interest-group=(), run-ad-auction=()"
  header Strict-Transport-Security "max-age=31536000;preload"
  header X-Content-Type-Options "nosniff"
  header X-Frame-Options "DENY"
  header Referrer-Policy "no-referrer"
  header Vary "Origin, Accept-Encoding"
  header -Server
}

# Set internal Farer ACME server
#matt.fa,
#www.matt.fa {
#  encode zstd gzip
#  root * /srv/apps/caddy/sites/matt.fa/public
#  tls acme https://acme.nic.fa/directory
#  handle /.well-known/hosting-provider {
#    respond "https://nic.fa"
#  }
#}
#www.matt.fa {
#  tls acme https://acme.nic.fa/directory
#  redir https://matt.fa{uri} 
#}

maatt.fr {
	import redirs
  import handle_404
  import base_heads

  root * /srv/maatt.fr/live
	encode zstd gzip
	file_server {
    precompressed br
  }
}
https://lite.maatt.fr,
http://lite.maatt.fr {
  import redirs
  import handle_404
  import base_heads

  root * /srv/lite.maatt.fr/live/
  encode zstd gzip
  file_server {
    precompressed br
  }
}

# Alt TLD and beta redirects
lite.beta.maatt.fr {
  redir http://lite.maatt.fr{uri}
}
maatt.eu,
www.maatt.fr,
www.maatt.eu,
beta.maatt.fr,
beta.maatt.eu {
  encode zstd gzip
  redir https://maatt.fr{uri}
}
